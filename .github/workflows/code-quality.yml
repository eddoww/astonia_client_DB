name: Code Quality

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy \
          cmake \
          libsdl2-dev \
          libsdl2-net-dev \
          libsdl2-mixer-dev \
          zlib1g-dev \
          libpng-dev

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,performance,portability \
                 --suppress=missingIncludeSystem \
                 --inline-suppr \
                 --template=gcc \
                 -I src \
                 src/ 2>&1 | tee cppcheck-report.txt || true

    - name: Upload cppcheck report
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
        retention-days: 14

  check-formatting:
    name: Check Code Style
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check line endings
      run: |
        echo "Checking for CRLF line endings..."
        if find src \( -name "*.c" -o -name "*.h" \) -exec file {} \; | grep -q CRLF; then
          echo "ERROR: Found files with CRLF line endings"
          find src \( -name "*.c" -o -name "*.h" \) -exec file {} \; | grep CRLF | head -5
          exit 1
        else
          echo "PASS: No CRLF line endings found"
        fi

    - name: Check for tabs vs spaces consistency
      run: |
        echo "Checking indentation consistency..."
        TABS=$(find src \( -name "*.c" -o -name "*.h" \) -exec grep -l $'\t' {} \; 2>/dev/null | head -5)
        if [ -n "$TABS" ]; then
          echo "ERROR: Found files with tabs:"
          echo "$TABS"
          exit 1
        else
          echo "PASS: No tabs found"
        fi

    - name: Check for trailing whitespace
      run: |
        echo "Checking for trailing whitespace..."
        TRAILING=$(find src \( -name "*.c" -o -name "*.h" \) -exec grep -l ' $' {} \; 2>/dev/null | head -10)
        if [ -n "$TRAILING" ]; then
          echo "WARNING: Found files with trailing whitespace:"
          echo "$TRAILING"
          echo "(This is a warning only, not failing the build)"
        else
          echo "PASS: No trailing whitespace found"
        fi

  build-warnings:
    name: Build with Extra Warnings
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libsdl2-net-dev \
          libsdl2-mixer-dev \
          zlib1g-dev \
          libpng-dev

    - name: Configure with extra warnings
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Debug \
              -DCMAKE_C_FLAGS="-Wall -Wextra -Wpedantic -Werror" \
              .. || true

    - name: Build
      run: |
        cd build
        make -j$(nproc) 2>&1 | tee ../build-warnings.txt || true

    - name: Upload warnings report
      uses: actions/upload-artifact@v4
      with:
        name: build-warnings
        path: build-warnings.txt
        retention-days: 14

